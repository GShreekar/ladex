<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>LADEX</title>
    <link rel="stylesheet" href="static/style.css?v=3">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script>
        // Force cache refresh on localhost
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('Localhost detected - forcing cache refresh');
        }
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>LADEX</h1>
            <div class="status-bar">
                <span id="peer-status">Connected peers: 0</span>
                <span id="peer-number">Peer: ---</span>
                <span id="connection-status" class="status-disconnected">Disconnected</span>
                <button id="logout-btn" class="icon-btn" title="Logout" style="display: none;">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M17,7L15.59,8.41L18.17,11H8V13H18.17L15.59,15.59L17,17L22,12L17,7M4,5H12V3H4C2.89,3 2,3.89 2,5V19A2,2 0 0,0 4,21H12V19H4V5Z"/>
                    </svg>
                </button>
            </div>
        </header>

        <main>
            <section class="upload-section">
                <div class="message-composer">
                    <div class="composer-buttons">
                        <button id="upload-files-btn" class="icon-btn" title="Upload Files">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                            </svg>
                        </button>
                        <button id="upload-folder-btn" class="icon-btn" title="Upload Folder">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                <path d="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z"/>
                            </svg>
                        </button>
                    </div>
                    <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
                    <button id="send-message-btn" class="icon-btn send-btn" title="Send Message">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                        </svg>
                    </button>
                </div>
                <div class="upload-area" id="upload-area" style="display: none;">
                    <input type="file" id="file-input" multiple webkitdirectory="" style="display: none;">
                    <input type="file" id="file-input-single" multiple style="display: none;">
                    <div class="upload-drop-text">
                        <p>Drop files here or click to select</p>
                    </div>
                </div>
            </section>

            <section class="files-section">
                <h2>Shared Files and Messages</h2>
                <div class="files-container">
                    <table id="files-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Size</th>
                                <th>Hosts</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="files-list">
                            <tr class="no-files">
                                <td colspan="5">No files shared yet. Upload some files to get started!</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <div id="progress-modal" class="modal">
        <div class="modal-content">
            <h3>File Transfer</h3>
            <div class="progress-info">
                <span id="progress-filename">Downloading file...</span>
                <span id="progress-percentage">0%</span>
            </div>
            <div class="progress-bar">
                <div id="progress-fill"></div>
            </div>
            <div class="progress-stats">
                <span id="progress-speed">0 MB/s</span>
                <span id="progress-eta">Calculating...</span>
            </div>
            <button id="cancel-transfer" class="btn secondary">Cancel</button>
        </div>
    </div>

    <div id="messages-modal" class="modal">
        <div class="modal-content messages-modal">
            <div class="modal-header">
                <h3>Message Content</h3>
                <button id="close-messages" class="close-btn">&times;</button>
            </div>
            <div id="message-content" class="message-content-viewer">
                <div class="message-details">
                    <div class="message-meta">
                        <span class="message-sender">From: <span id="modal-sender"></span></span>
                        <span class="message-time">Sent: <span id="modal-time"></span></span>
                    </div>
                    <div class="message-text-container">
                        <div class="message-text" id="modal-message-text"></div>
                        <button id="copy-message-btn" class="icon-btn copy-btn" title="Copy Message">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                <path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="static/jszip.min.js"></script>
    <script src="static/app.js?v=3"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const logoutBtn = document.getElementById('logout-btn');
            
            // More robust authentication check
            console.log('Checking authentication status...');
            fetch('/auth-status', { 
                method: 'GET',
                cache: 'no-cache',
                headers: {
                    'Cache-Control': 'no-cache'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Auth check response:', data);
                if (data.authenticated) {
                    console.log('User is authenticated - showing logout button');
                    logoutBtn.style.display = 'block';
                    logoutBtn.addEventListener('click', function() {
                        console.log('Logout button clicked');
                        fetch('/logout', { 
                            method: 'POST',
                            cache: 'no-cache',
                            headers: {
                                'Cache-Control': 'no-cache'
                            }
                        }).finally(() => {
                            console.log('Redirecting to login...');
                            window.location.href = '/login';
                        });
                    });
                } else {
                    console.log('User not authenticated - logout button hidden');
                }
            })
            .catch(error => {
                console.log('Auth check failed:', error);
            });
        });
    </script>
</body>
</html>
